# SPDX-FileCopyrightText: 2022-2025 Technology Innovation Institute (TII)
# SPDX-License-Identifier: Apache-2.0

*** Settings ***
Library             ../lib/PlugLibrary/PlugLibrary.py  ${PLUG_TYPE}
Library             ../lib/SwitchbotLibrary.py  ${SWITCH_TOKEN}  ${SWITCH_SECRET}


*** Keywords ***

Reboot Device
    [Arguments]       ${delay}=5
    [Documentation]   Turn off power of device, wait for given amount of seconds and turn on the power
    Log To Console    ${\n}Turning device off...
    Turn Plug Off
    Sleep    ${delay}
    Log To Console    Turning device on...
    Turn Plug On

Reboot Device Via Relay
    [Arguments]       ${delay}=5
    [Documentation]   Turn off power of device, wait for given amount of seconds and turn on the power
    # Open Relay Serial Port    ${RELAY_SERIAL_PORT}
    Log To Console    ${\n}Turning device off...
    Turn Relay Off    ${RELAY_NUMBER}
    Sleep    ${delay}
    Log To Console    Turning device on...
    Turn Relay On     ${RELAY_NUMBER}

Reboot Laptop
    [Arguments]       ${delay}=15
    [Documentation]   Turn off the laptop by pressing power button for 10 sec turn on by short pressing power button
    IF  "${DEVICE_TYPE}" == "lenovo-x1" or "${DEVICE_TYPE}" == "darter-pro"
        ${delay}      Set variable    20
    END
    Log To Console    ${\n}Turning device off...
    Press Button      ${SWITCH_BOT}-OFF
    Sleep    ${delay}
    Log To Console    Turning device on...
    Press Button      ${SWITCH_BOT}-ON

Soft Reboot Device
    [Documentation]  Reboot device from ghaf-host
    ${device_is_available}   Ping Host   ${DEVICE_IP_ADDRESS}
    IF  ${device_is_available}
        Switch to vm   ghaf-host
        ${output}  Execute Command  reboot  sudo=True  sudo_password=${password}
        Log  ${output}
        Log To Console  Rebooting device from command line
    ELSE
        FAIL    Device expected to be available but not responding.
    END

Verify Reboot and Connect
    [Documentation]   Verify that device rebooted and connect
    ${device_not_available}    Run Keyword And Return Status  Wait Until Keyword Succeeds  30s  2s  Check If Ping Fails
    IF  ${device_not_available} == True
        Log To Console            Device is down
    ELSE
        FAIL                      Device didn't shut down at reboot.
    END
    Sleep   20
    Check If Device Is Up         range=60
    IF    ${IS_AVAILABLE} == False
        FAIL                      The device did shut down but didn't start in reboot.
    ELSE
        Log To Console            Device started
    END
    Sleep   30
    Connect    iterations=10